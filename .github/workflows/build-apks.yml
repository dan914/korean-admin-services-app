name: Build Korean Admin Apps APKs

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-main-app:
    name: Build Main App APK
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd "./행정도우미"
        flutter pub get
        
    - name: Build APK
      run: |
        cd "./행정도우미"
        flutter build apk --release --verbose
        
    - name: Upload Main App APK
      uses: actions/upload-artifact@v4
      with:
        name: korean-admin-main-app-apk
        path: ./행정도우미/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

  build-admin-app:
    name: Build Admin Panel APK
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd admin_app
        flutter pub get
        
    - name: Build APK
      run: |
        cd admin_app
        flutter build apk --release --verbose
        
    - name: Upload Admin App APK
      uses: actions/upload-artifact@v4
      with:
        name: korean-admin-panel-app-apk
        path: admin_app/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

  create-release:
    name: Create Release with APKs
    needs: [build-main-app, build-admin-app]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
    - name: Download Main App APK
      uses: actions/download-artifact@v4
      with:
        name: korean-admin-main-app-apk
        path: ./apks/main/
        
    - name: Download Admin App APK
      uses: actions/download-artifact@v4
      with:
        name: korean-admin-panel-app-apk
        path: ./apks/admin/
        
    - name: Generate Release Tag
      id: tag
      run: echo "release_tag=v$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
    - name: Prepare APKs for Release
      run: |
        mkdir -p release
        cp ./apks/main/app-release.apk ./release/korean-admin-main-app-${{ steps.tag.outputs.release_tag }}.apk
        cp ./apks/admin/app-release.apk ./release/korean-admin-panel-app-${{ steps.tag.outputs.release_tag }}.apk
        ls -la release/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push'
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: Korean Admin Apps Release ${{ steps.tag.outputs.release_tag }}
        body: |
          ## Korean Administrative Services Apps
          
          This release contains APK files for both applications:
          
          ### 📱 Main Application (행정도우미)
          - Real-time form validation
          - Korean phone number formatting
          - Rate limiting protection
          - Offline-capable interface
          
          ### 🛠️ Admin Panel Application
          - Dashboard with statistics
          - Application management
          - Pagination and search
          - Session management
          
          ### 📥 Installation Instructions
          1. Download the appropriate APK file
          2. Enable "Install from Unknown Sources" in Android settings
          3. Tap the APK file to install
          4. Or use ADB: `adb install <apk-file>`
          
          ### 🔗 Web Versions
          Both apps also work as Progressive Web Apps (PWA) in any browser.
          
          ---
          🤖 Generated automatically by GitHub Actions
        files: ./release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}